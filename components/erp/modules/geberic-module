"use client"

import { useState, useMemo } from "react"
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card"
import { Table, TableHeader, TableRow, TableHead, TableBody, TableCell } from "@/components/ui/table"
import { Input } from "@/components/ui/input"
import { Button } from "@/components/ui/button"
import { Label } from "@/components/ui/label"
import { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from "@/components/ui/select"
import { Badge } from "@/components/ui/badge"
import type { ModuleDef } from "@/modules"

interface GenericModuleProps {
  /** The module definition to render. */
  module: ModuleDef
}

/**
 * GenericModule renders a configurable demo module based on a list of fields.  It
 * maintains a local table of entries and a form for creating new records.  The
 * component does not persist data; it is purely for interactive exploration.
 */
export function GenericModule({ module }: GenericModuleProps) {
  // Derive an initial form state from the module definition.  Memoising this
  // prevents unnecessary recomputation on re‑renders.
  const initialFormState = useMemo(() => {
    const state: Record<string, string> = {}
    for (const field of module.fields) {
      state[field.name] = ""
    }
    return state
  }, [module.fields])

  // Keep track of the form inputs and the list of added entries.
  const [formData, setFormData] = useState<Record<string, string>>(initialFormState)
  const [entries, setEntries] = useState<Record<string, string>[]>([])

  // Update a single field value in the form.
  function handleChange(fieldName: string, value: string) {
    setFormData((prev) => ({ ...prev, [fieldName]: value }))
  }

  // Handle form submission: add the current form data to the table and reset the form.
  function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    setEntries((prev) => [...prev, { ...formData }])
    setFormData(initialFormState)
  }

  return (
    <div className= "p-4 space-y-6" >
    {/* Overview card */ }
    < Card >
    <CardHeader>
    <CardTitle className="text-2xl font-semibold flex flex-col gap-1" >
      { module.title }
      < span className = "text-sm font-normal text-muted-foreground" > { module.description } </span>
        </CardTitle>
        </CardHeader>
        < CardContent className = "space-y-2" >
          <div className="flex flex-wrap gap-2" >
          {
            module.features.map((feature) => (
              <Badge key= { feature } className = "text-xs font-normal" >
              { feature }
              </Badge>
            ))
          }
            </div>
            </CardContent>
            </Card>

  {/* Form for adding a new record */ }
  <form onSubmit={ handleSubmit } className = "space-y-4" >
    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4" >
    {
      module.fields.map((field) => (
        <div key= { field.name } className = "flex flex-col gap-2" >
        <Label>{ field.name } </Label>
              {
          field.type === "select" ? (
            <Select
                  value= { formData[field.name]}
                  onValueChange={(value) => handleChange(field.name, value)
    }
      >
      <SelectTrigger>
      <SelectValue placeholder={ `Selecciona ${field.name.toLowerCase()}` } />
        </SelectTrigger>
        <SelectContent>
  {
    field.options?.map((opt) => (
      <SelectItem key= { opt } value = { opt } >
      { opt }
      </SelectItem>
    ))
  }
  </SelectContent>
    </Select>
              ) : (
    <Input
                  type= { field.type === "number" ? "number" : field.type === "date" ? "date" : "text" }
  value = { formData[field.name]}
  onChange = {(e) => handleChange(field.name, e.target.value)
}
                />
              )}
</div>
          ))}
</div>
  < Button type = "submit" > Agregar registro </Button>
    </form>

{/* Table of records */ }
<Card>
  <CardHeader>
  <CardTitle className="text-xl" > Registros </CardTitle>
    </CardHeader>
    <CardContent>
{
  entries.length === 0 ? (
    <p className= "text-sm text-muted-foreground" > No hay registros aún.</p>
          ) : (
    <Table>
    <TableHeader>
    <TableRow>
    {
      module.fields.map((field) => (
        <TableHead key= { field.name } > { field.name } </TableHead>
      ))
    }
    </TableRow>
    </TableHeader>
    <TableBody>
                {
    entries.map((entry, idx) => (
      <TableRow key= { idx } >
      {
        module.fields.map((field) => (
          <TableCell key= { field.name } > { entry[field.name]} </TableCell>
        ))
  }
  </TableRow>
                ))
}
</TableBody>
  </Table>
          )}
</CardContent>
  </Card>
  </div>
  )
}

